---
title: "utility"
format: html
editor: visual
---

```{r}
# Install baseballr through  pacman - this may take ~30 mins
if (!requireNamespace('pacman', quietly = TRUE)){
  install.packages('pacman')
}
pacman::p_load_current_gh("billpetti/baseballr")
library(dplyr)
library(stringi)
library(tidyverse)
```

```{r}
rs_data <- retrosheet_data(
  path_to_directory = NULL,
  years_to_acquire = c(seq(2016,2025)),
  sequence_years = FALSE
)
```

```{r}
rs_dataframe <- names(rs_data) %>% lapply(function(year) {
  # print(year)
  thing <- rs_data[[year]]$events %>% 
    select(year, bat_id, pit_id, bat_hand_cd, pit_hand_cd, 
           game_id, away_team_id, bat_home_id, event_cd, ab_fl, sf_fl, sh_fl) %>% 
    mutate(home_team_id=substr(game_id, 1, 3)) 
  return(thing)
}) %>% bind_rows()
```

Russ Carleton in 2013 wrote a Baseball Prospectus article called "The Zobrist Effect" trying to answer this question. He identified three sources of value that a utility player creates, and then made some rough estimates as to how much WAR each one produces. I attempted to replicate this using data from 2016-2025, and got similar results.

The first step was to define what even makes a platoon player: what percentage of your plate appearances have to come against one hand for you to be a platoon? First up to consider that is how many plate appearances on average come against lefties?

```{r}
rs_dataframe %>% 
  group_by(year, pit_hand_cd) %>% 
    summarise(num=n()) %>% 
    mutate(percent=num / sum(num))
  

```

The answer changes year to year, but the average looks to be about 27%.

I first made guesstimates of 15% as the maximim percent of PAs against lefties for a righty-facing platoon bat, and 50% as the minimum threshold for PAs against lefties for a lefty-facing platoon bat.

I reviewed a few of the players at the fringe of these numbers and was reasonably satisfied that I would consider them "platoon bats." But ultimately I found a [2016 Fangraphs article from Scott Spratt](https://fantasy.fangraphs.com/realized-platoon-rates/) having calculated these thresholds a little more carefully, and his results were 11% and 55%, slightly stricter than I had originally expected.

```{r}
RIGHT_PLATOON_THRESHOLD <- 0.55
LEFT_PLATOON_THRESHOLD <- 0.11
platoon_players <-rs_dataframe %>% 
  mutate(batter_team=ifelse(bat_home_id==1, home_team_id, away_team_id)) %>%
  group_by(year, bat_id, pit_hand_cd) %>% 
    summarise(num=n(), team=first(batter_team)) %>% 
    mutate(total_abs=sum(num)) %>% 
    mutate(percent=num / total_abs) %>% 
    mutate(plays_against=ifelse(percent >= RIGHT_PLATOON_THRESHOLD, 
                                "L", "R")) %>% 
   filter(sum(num) > 150) %>% 
  ungroup() %>% 
  filter(pit_hand_cd == 'L' & (percent >= RIGHT_PLATOON_THRESHOLD | percent <= LEFT_PLATOON_THRESHOLD))

print(platoon_players)
print(platoon_players %>% select(plays_against) %>% table())
```

I used this threshold to find all true platoon seasons with at least 150 PAs between 2016 and 2025, the result being 41 lefty-facing platoon bats and 118 righty-facing platoon bats.

```{r}

```

Carleton writes that of the 700 PAs taken over the course of a season without a platoon, about half come against the correct handedness. I wanted to calculate the percentage that could be changed, with a platoon, to the correct hand.

To do this, I filtered my platoon dataset to just teams that had exactly two platoon bats in a year, one of each hand. This way I could be reasonably confident that they were spelling each other in the lineup. The average total PAs of these duos is 515, so they weren't taking all 700 position ABs (probably due to injuries, rest, and using other players given that platoon bats tend to be not as good overall as guys who can hit both sides).

```{r}
one_platoon_teams <- platoon_players %>% 
  group_by(year, team) %>% 
  filter(n() == 2) %>%
  filter(first(plays_against) != last(plays_against)) %>% 
  arrange(year, team)
```

Back to basics and Russ Carleton. Carleton says that each positon takes around 700 PAs, and on average half on the correct side. I say that under a platoon, you can get to about 70% of PAs taken by the right side. So this is instead of 350 bad PAs, 210 bad PAs. That saves 140 PAs, which can be taken with the proper side

```{r}
against_righty_average <- one_platoon_teams %>% 
  filter(plays_against=='R')
print(mean(against_righty_average$percent))

against_lefty_average <- one_platoon_teams %>% 
  filter(plays_against=='L')
print(1 - mean(against_lefty_average$percent))


# lefties go from 73% to 91% right
# righties go from 27% to 63% right

```

My results: In a platoon, righty-specialist hitters take about 9.4% of at-bats against lefties, and lefty-specialist hitters take about 37% of at-bats against righties. So in a proper platoon you get 91% of at-bats against lefties correct and 63% of at-bats against righties correct. With the average of 27% of PAs being against lefties and 73% against righties, this average out to about 70%.

```{r}
PAs_correct_with_platoon <- 0.906*0.27 + 0.63*0.73
print(PAs_correct_with_platoon)
```

With 700 PAs, 70% correct is 490 instead of 350 (at 50% correct). That's 140 PAs that enjoy the handedness advantage. Obviously this simplifies out the factor that one side of the platoon could be better than the other, but supposing they are equally good hitters, we can find the total run value created by the platoon by multiplying that by runs created per plate appearance.

Carleton finds the platoon advantage to be 22 points worth of OBP for fringe players (100 to 400 PAs) and 19 points of OBP for full-tme player

> To look at this, I used the odds-ratio method to isolate all cases where a batter who had \> between 100 PA and 400 PA in the season in question (2003-2012) was at bat and opposing a pitcher who faced at least 250 batters. I looked at the expected OBP of the matchup, coded \> whether the batter and pitcher were of the same hand or different handedness, and ran a \> logistic regression using both inputs. The effect for fringe regulars and part-timers of the \> platoon effect was about 22 points' worth of OBP. For regulars (400 or more PA), it was 19.

```{r}
guts <- read.csv("fangraphs-guts-data.csv")

event_counter <- function(grouped_df) {
  grouped_df <- grouped_df %>% 
     summarize(singles=sum(event_cd==20), 
         unint_walks=sum(event_cd == 14),
         int_walks=sum(event_cd == 15),
         hbps = sum(event_cd == 16),
         doubles=sum(event_cd==21),
         triples=sum(event_cd==22),
         home_runs=sum(event_cd==23),
         at_bats=sum(ab_fl==TRUE),
         sac_flies=sum(sf_fl==TRUE),
         sac_hits=sum(sh_fl==TRUE),
         .groups="keep"
         ) %>% 
    mutate(plate_appearences=at_bats+unint_walks+int_walks+hbps+sac_flies+sac_hits)
  return(grouped_df)
}


event_counter2 <- function(grouped_df) {
  grouped_df <- grouped_df %>% 
     mutate(singles=event_cd==20, 
         unint_walks=event_cd == 14,
         int_walks=event_cd == 15,
         hbps = event_cd == 16,
         doubles=event_cd==21,
         triples=event_cd==22,
         home_runs=event_cd==23,
         at_bats=ab_fl==TRUE,
         sac_flies=sf_fl==TRUE,
         sac_hits=sh_fl==TRUE,
         ) %>% 
    mutate(plate_appearences=at_bats+unint_walks+int_walks+hbps+sac_flies+sac_hits)
  return(grouped_df)
}

calculate_woba <- function(grouped_df) {
  grouped_df <- grouped_df %>% 
  left_join(guts, by=join_by(year==Season)) %>% 
  mutate(woba_num=wBB*unint_walks +
           wHBP * hbps +
           w1B * singles +
           w2B * doubles +
           w3B * triples +
           wHR * home_runs) %>% 
  mutate(woba_denom=at_bats + unint_walks + sac_flies + hbps) %>% 
  mutate(woba=woba_num/woba_denom)
  return(grouped_df)
  }

rs_dataframe_counts <- rs_dataframe %>% 
  group_by(year, bat_id, pit_hand_cd) %>%
  event_counter() %>% 
  calculate_woba()
 

rs_dataframe_platoons <- rs_dataframe %>% 
  group_by(pit_hand_cd, bat_hand_cd, year) %>% 
  event_counter() %>% 
  calculate_woba()

pitcher_batters_faced <- rs_dataframe %>% 
  group_by(pit_id, year) %>% 
  filter(ab_fl==TRUE | sh_fl == TRUE | sf_fl == TRUE |
           event_cd==14 | # unint walk
           event_cd==15 | # int walk
           event_cd==16 #HBP
         ) %>% 
  summarize(batters_faced=n())

batter_pas <- rs_dataframe %>% 
   group_by(bat_id, year) %>% 
  filter(ab_fl==TRUE | sh_fl == TRUE | sf_fl == TRUE |
           event_cd==14 | # unint walk
           event_cd==15 | # int walk
           event_cd==16 #HBP
         ) %>% 
  summarize(plate_appearences=n())

pitcher_wobas <- rs_dataframe %>% 
  group_by(pit_id, year) %>% 
  event_counter() %>% 
  calculate_woba() %>% 
  rename(pitcher_woba=woba) %>% 
  select(pit_id, year, pitcher_woba)

batter_wobas <- rs_dataframe %>% 
  group_by(bat_id, year) %>% 
  event_counter() %>% 
  calculate_woba() %>% 
  rename(batter_woba=woba) %>% 
  select(bat_id, year, batter_woba)

league_wobas <- guts %>% 
  select(Season, wOBA) %>% 
  rename(av_woba=wOBA)

fringe_players <- rs_dataframe %>% 
  left_join(pitcher_batters_faced, 
            by=join_by(year==year, pit_id==pit_id)) %>% 
  filter(batters_faced >= 250) %>% 
  left_join(batter_pas, 
            by=join_by(year==year, bat_id==bat_id)) %>% 
  filter(plate_appearences >= 100 & plate_appearences <= 400) %>% 
  mutate(same_hand=bat_hand_cd==pit_hand_cd) %>%
  left_join(pitcher_wobas, by=join_by(year==year, pit_id==pit_id)) %>% 
  left_join(batter_wobas, by=join_by(year==year, bat_id==bat_id)) %>% 
  
  # group_by(year, bat_id, same_hand) %>% 
  event_counter2() %>% 
  filter(plate_appearences == 1) %>% 
  calculate_woba() %>% 
  left_join(league_wobas, by=join_by(year==Season)) %>% 
  select(same_hand, pitcher_woba, batter_woba, av_woba, woba) %>% 
  filter(!is.na(woba)) %>% 
  mutate(expected_woba=pitcher_woba + batter_woba - av_woba)
  # group_by(year, bat_id) %>%  

  
regular_players <- rs_dataframe %>% 
  left_join(pitcher_batters_faced, 
            by=join_by(year==year, pit_id==pit_id)) %>% 
  filter(batters_faced >= 250) %>% 
  left_join(batter_pas, 
            by=join_by(year==year, bat_id==bat_id)) %>% 
  filter(plate_appearences > 400) %>% 
  mutate(same_hand=bat_hand_cd==pit_hand_cd) %>%
  left_join(pitcher_wobas, by=join_by(year==year, pit_id==pit_id)) %>% 
  left_join(batter_wobas, by=join_by(year==year, bat_id==bat_id)) %>% 
  event_counter2() %>% 
  filter(plate_appearences == 1) %>% 
  calculate_woba() %>% 
  left_join(league_wobas, by=join_by(year==Season)) %>% 
  select(same_hand, pitcher_woba, batter_woba, av_woba, woba) %>% 
  filter(!is.na(woba)) %>% 
  mutate(expected_woba=pitcher_woba + batter_woba - av_woba)
```

```{r}
fringe_fit <- lm(woba ~ expected_woba + same_hand, data = fringe_players)
print(summary(fringe_fit))
regular_fit <- lm(woba ~ expected_woba + same_hand, data = regular_players)
print(summary(regular_fit))
```

\
I did my best to recreate his protocol in that paragraph using wOBA instead of OBP, and my updated data. The main difference is that instead of expected OBP of a matchup (which he calculated using the "odds-ratio method," I calculated expected wOBA in a rather primitive but hopefully functional way - batter wOBA + pitcher wOBA - leaguewOBA. I then ran linear regressions predicting the wOBA outcome of a plate appearance given the expected wOBA and whether the hitter and pitcher had the same hand. My results came out similar to Carleton's: an increase of about 0.02 wOBA for having the platoon advantage for fringe/part-time players, and a 0.017 increase for full-time players.

```{r}
fringe_advantage_woba <- 0.020620
wobas_10 <- guts %>% filter(Season >= 2016) %>% select(wOBAScale)
woba_scale <- mean(wobas_10$wOBAScale)
regular_advantage_woba <- 0.016817
pas_saved <- 140
fringe_runs_gained <- (fringe_advantage_woba / woba_scale) * pas_saved
fringe_war_gained <- fringe_runs_gained / 10
regular_runs_gained <- (regular_advantage_woba / woba_scale) * pas_saved
regular_war_gained <- regular_runs_gained / 10
print(fringe_war_gained)
print(regular_war_gained)
```

Since wOBA translates very well into runs gained, I treat the platoon advantage as the "difference over league average," divide by the average wOBA scale over my dataset, and multiply by the 140 PAs in which the advantage is observed. For enabling the platoons of part-time players, this translates to 2.4 runs gained, around 0.24 WAR, and for full-time players it's around 1.9 runs or 0.19 WAR.

This is all pretty crude but a little less crude than Carleton's estimates: I think it's fair to say that the value of enabling a platoon is about 0.2 WAR. Is that enough to be worth changing your team-building philosophy for? No, Tom Tango would probably call it a rounding error. But it is a non-zero value that a Ben Zobrist type player makes it very easy to get your hands on.

## Rule 5

```{r}
# https://www.baseball-reference.com/data/war_daily_bat.txt
rule_5 <- read.csv("rule5.csv") %>% 
  mutate(Player=gsub(" Jr.", "", Player))

batting_war <- read.csv('batting_war.csv') %>% 
  # mutate(WAR=replace(WAR, is.na(WAR), 0)) %>%
  group_by(mlb_ID) %>% 
  summarize(name=first(name_common), war=sum(as.numeric(WAR)), debut=min(year_ID), batter_years_played=n_distinct(year_ID)) %>% 
  mutate(name=stri_trans_general(name, "Latin-ASCII"))

pitching_war <- read.csv("pitching_war.csv") %>% 
  group_by(mlb_ID) %>% 
  summarize(name=first(name_common), war=sum(as.numeric(WAR)), debut=min(year_ID), pitcher_years_played=n_distinct(year_ID)) %>% 
  mutate(name=stri_trans_general(name, "Latin-ASCII"))

```

```{r}

rule_5 <- rule_5 %>% 
  filter(Year >= 2010) %>% 
  mutate(five_later = Year + 5) %>% 
  left_join(batting_war, by=join_by(Player == name, Year <= debut, five_later >= debut)) %>% 
  left_join(pitching_war, by=join_by(Player == name, Year <= debut, five_later >= debut)) %>% 
  mutate(WAR = case_when(
    is.na(war.x) ~ war.y,
    is.na(war.y) ~ war.x,
    TRUE ~ war.x + war.y
  ))  %>% 
  mutate(years_played=case_when(
    is.na(pitcher_years_played) ~ batter_years_played,
    is.na(batter_years_played) ~ pitcher_years_played,
    TRUE ~ pmax(batter_years_played, pitcher_years_played)
  )) %>% 
  select(Year, Player, Returned, Traded, WAR, years_played) %>% 
  mutate(WAR=coalesce(WAR, 0), years_played=coalesce(years_played, 0)) %>% 
  mutate(WAR_per_year = ifelse(years_played == 0, 0, WAR/years_played))
```

```{r}
sum(rule_5$WAR) / sum(rule_5$years_played)


```

\-\--

## Junkyard

```{r}
platoon_players %>% group_by(plays_against) %>% 
  summarize(total = n())
print(platoon_players)
total_players <- rs_dataframe %>% 
  group_by(year, bat_id, bat_hand_cd) %>% 
  summarize(total = n())
print(total_players)
```
